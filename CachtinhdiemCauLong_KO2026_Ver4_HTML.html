<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VT Healthcare Badminton - Tournament Manager 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lexend:wght@400;600;800&display=swap');
        
        :root {
            --vt-primary: #26b1a5; 
            --vt-dark: #1e8e84;
            --vt-bg: #fdfdfd;
        }
        
        body {
            background-color: var(--vt-bg);
            font-family: 'Lexend', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        .bg-vt { background-color: var(--vt-primary); }
        .text-vt { color: var(--vt-primary); }
        
        .tab-active {
            background-color: white;
            color: var(--vt-primary);
            box-shadow: 0 10px 15px -3px rgba(38, 177, 165, 0.2);
            transform: translateY(-1px);
        }

        .court-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade { animation: fadeIn 0.4s ease-out forwards; }
        
        input:read-only {
            color: #94a3b8;
            cursor: not-allowed;
        }

        .podium-1 { background: linear-gradient(135deg, #ffd700, #ffae00); }
        .podium-2 { background: linear-gradient(135deg, #c0c0c0, #95a5a6); }
        .podium-3 { background: linear-gradient(135deg, #cd7f32, #a0522d); }
    </style>
</head>
<body class="pb-24">

    <div id="main-app">
        <header class="bg-vt text-white shadow-xl sticky top-0 z-50 rounded-b-[2.5rem]">
            <div class="max-w-6xl mx-auto px-6 py-5 flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <div class="bg-white/20 p-2.5 rounded-2xl backdrop-blur-md">
                        <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="font-extrabold text-xl leading-none tracking-tight">VT OLYMPIC</h1>
                        <p class="text-[11px] opacity-90 font-medium uppercase tracking-[0.2em] mt-1">Badminton Kickoff 2026</p>
                    </div>
                </div>
                <button onclick="resetTournament()" class="bg-white/10 hover:bg-white/20 p-3 rounded-2xl transition-all">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                </button>
            </div>
            <div class="max-w-6xl mx-auto px-6 pb-6 overflow-x-auto">
                <div class="flex bg-black/10 p-1.5 rounded-[1.5rem] gap-1.5 backdrop-blur-sm min-w-[400px]">
                    <button onclick="switchTab('tu-ket')" id="tab-tu-ket" class="flex-1 py-3 text-[10px] font-extrabold rounded-xl transition-all tab-active uppercase tracking-wider">T·ª© K·∫øt</button>
                    <button onclick="switchTab('ban-ket')" id="tab-ban-ket" class="flex-1 py-3 text-[10px] font-extrabold rounded-xl transition-all text-white/70 uppercase tracking-wider">B√°n K·∫øt</button>
                    <button onclick="switchTab('chung-ket')" id="tab-chung-ket" class="flex-1 py-3 text-[10px] font-extrabold rounded-xl transition-all text-white/70 uppercase tracking-wider">Chung K·∫øt</button>
                    <button onclick="switchTab('bxh')" id="tab-bxh" class="flex-1 py-3 text-[10px] font-extrabold rounded-xl transition-all text-white/70 uppercase tracking-wider">BXH üèÜ</button>
                </div>
            </div>
        </header>

        <main class="max-w-6xl mx-auto px-6 mt-8">
            <div id="round-selector" class="mb-8 flex justify-center gap-3">
                <button onclick="switchRound(1)" id="btn-round-1" class="px-6 py-2 rounded-full text-xs font-bold border border-vt transition-all">L∆∞·ª£t 1 (Tr·∫≠n 1-2)</button>
                <button onclick="switchRound(2)" id="btn-round-2" class="px-6 py-2 rounded-full text-xs font-bold border border-vt transition-all">L∆∞·ª£t 2 (Tr·∫≠n 3-4)</button>
            </div>

            <div class="mb-8 text-center animate-fade">
                <h2 id="phase-title" class="text-3xl font-extrabold text-slate-800 tracking-tight mb-1">V√≤ng T·ª© K·∫øt</h2>
                <div class="flex items-center justify-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-vt animate-pulse"></span>
                    <p id="round-subtitle" class="text-slate-400 text-[13px] font-medium tracking-wide uppercase">T·ª± ƒë·ªông kh√≥a t√™n ƒë·ªôi th·∫Øng/thua v√†o v√≤ng sau</p>
                </div>
            </div>

            <div id="court-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>

            <div id="bxh-container" class="hidden animate-fade">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8" id="bxh-content"></div>
            </div>

            <!-- Th·ªÉ l·ªá gi·∫£i ƒë·∫•u -->
            <section class="mt-16 pt-12 border-t border-slate-100 mb-12">
                <div class="bg-white rounded-[2.5rem] p-8 md:p-12 shadow-sm border border-slate-100">
                    <div class="flex items-center gap-4 mb-8">
                        <div class="w-12 h-12 bg-slate-100 rounded-2xl flex items-center justify-center text-slate-800">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        </div>
                        <h3 class="text-2xl font-black text-slate-800 uppercase tracking-tight">Th·ªÉ l·ªá gi·∫£i ƒë·∫•u VT Olympic 2026</h3>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 text-slate-600">
                        <div class="space-y-4">
                            <div class="flex gap-4">
                                <span class="flex-shrink-0 w-8 h-8 rounded-full bg-vt/10 text-vt flex items-center justify-center font-bold text-xs">01</span>
                                <p class="text-sm leading-relaxed"><span class="font-bold text-slate-800">H√¨nh th·ª©c:</span> Thi ƒë·∫•u lo·∫°i tr·ª±c ti·∫øp. Chia l√†m 3 n·ªôi dung: ƒê√¥i Nam, ƒê√¥i N·ªØ v√† ƒê√¥i Nam-N·ªØ.</p>
                            </div>
                            <div class="flex gap-4">
                                <span class="flex-shrink-0 w-8 h-8 rounded-full bg-vt/10 text-vt flex items-center justify-center font-bold text-xs">02</span>
                                <p class="text-sm leading-relaxed"><span class="font-bold text-slate-800">S·ªë hi·ªáp:</span> M·ªói tr·∫≠n ƒë·∫•u g·ªìm t·ªëi ƒëa 3 hi·ªáp (Best of 3). ƒê·ªôi th·∫Øng 2 hi·ªáp tr∆∞·ªõc s·∫Ω th·∫Øng chung cu·ªôc.</p>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <div class="flex gap-4">
                                <span class="flex-shrink-0 w-8 h-8 rounded-full bg-vt/10 text-vt flex items-center justify-center font-bold text-xs">03</span>
                                <p class="text-sm leading-relaxed"><span class="font-bold text-slate-800">C√°ch t√≠nh ƒëi·ªÉm:</span> Ch·∫°m ƒëi·ªÉm 21 m·ªói hi·ªáp (Rally point). N·∫øu h√≤a 20-20, ƒë·ªôi c√°ch 2 ƒëi·ªÉm tr∆∞·ªõc th·∫Øng (t·ªëi ƒëa 30).</p>
                            </div>
                            <div class="flex gap-4">
                                <span class="flex-shrink-0 w-8 h-8 rounded-full bg-vt/10 text-vt flex items-center justify-center font-bold text-xs">04</span>
                                <p class="text-sm leading-relaxed"><span class="font-bold text-slate-800">Ph√¢n h·∫°ng:</span> ƒê·ªôi th·∫Øng B√°n k·∫øt v√†o Chung k·∫øt tranh Nh·∫•t-Nh√¨. ƒê·ªôi thua B√°n k·∫øt tranh h·∫°ng Ba.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal -->
    <div id="history-modal" class="fixed inset-0 bg-slate-900/80 z-[100] hidden items-center justify-center p-6 backdrop-blur-md">
        <div class="bg-white w-full max-w-sm rounded-[2.5rem] p-8 shadow-2xl scale-95 transition-transform duration-200">
            <h3 class="text-xl font-extrabold text-slate-800 text-center mb-6">X√°c nh·∫≠n hi·ªáp ƒë·∫•u</h3>
            <div class="flex justify-around items-center bg-slate-50 p-6 rounded-3xl mb-8">
                <div class="text-center flex-1">
                    <div id="modal-team-a" class="text-[10px] font-bold text-slate-400 mb-1 uppercase truncate"></div>
                    <div id="modal-score-a" class="text-4xl font-black text-vt">0</div>
                </div>
                <div class="text-slate-300 font-black italic text-sm">VS</div>
                <div class="text-center flex-1">
                    <div id="modal-team-b" class="text-[10px] font-bold text-slate-400 mb-1 uppercase truncate"></div>
                    <div id="modal-score-b" class="text-4xl font-black text-slate-800">0</div>
                </div>
            </div>
            <div class="flex gap-4">
                <button onclick="closeModal()" class="flex-1 py-4 text-sm font-bold text-slate-400 bg-slate-100 rounded-2xl">H·ªßy</button>
                <button id="confirm-finish-btn" class="flex-1 py-4 text-sm font-bold text-white bg-vt rounded-2xl">X√°c nh·∫≠n</button>
            </div>
        </div>
    </div>
    
    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-8 py-4 rounded-3xl text-xs font-bold shadow-2xl opacity-0 translate-y-10 transition-all z-[110] pointer-events-none"></div>

    <script>
        let currentTab = 'tu-ket';
        let currentRound = 1;
        // v12: Adding Rankings and Rules
        let db = JSON.parse(localStorage.getItem('vt_badminton_db_v12')) || null;

        const matchTemplates = {
            'tu-ket': {
                1: [
                    { id: 'tk1_1', label: 'NAM TK1', court: 'S√¢n 1', next: { id: 'bk1', slot: 'A' } },
                    { id: 'tk2_1', label: 'NAM TK2', court: 'S√¢n 2', next: { id: 'bk1', slot: 'B' } },
                    { id: 'tk3_1', label: 'N·ªÆ TK1', court: 'S√¢n 3', next: { id: 'bk3', slot: 'A' } },
                    { id: 'tk4_1', label: 'N·ªÆ TK2', court: 'S√¢n 4', next: { id: 'bk3', slot: 'B' } },
                    { id: 'tk5_1', label: 'NAM-N·ªÆ TK1', court: 'S√¢n 5', next: { id: 'bk5', slot: 'A' } },
                    { id: 'tk6_1', label: 'NAM-N·ªÆ TK2', court: 'S√¢n 6', next: { id: 'bk5', slot: 'B' } },
                ],
                2: [
                    { id: 'tk1_2', label: 'NAM TK3', court: 'S√¢n 1', next: { id: 'bk2', slot: 'A' } },
                    { id: 'tk2_2', label: 'NAM TK4', court: 'S√¢n 2', next: { id: 'bk2', slot: 'B' } },
                    { id: 'tk3_2', label: 'N·ªÆ TK3', court: 'S√¢n 3', next: { id: 'bk4', slot: 'A' } },
                    { id: 'tk4_2', label: 'N·ªÆ TK4', court: 'S√¢n 4', next: { id: 'bk4', slot: 'B' } },
                    { id: 'tk5_2', label: 'NAM-N·ªÆ TK3', court: 'S√¢n 5', next: { id: 'bk6', slot: 'A' } },
                    { id: 'tk6_2', label: 'NAM-N·ªÆ TK4', court: 'S√¢n 6', next: { id: 'bk6', slot: 'B' } },
                ]
            },
            'ban-ket': {
                1: [
                    { id: 'bk1', label: 'NAM BK1', court: 'S√¢n 1', nextWinner: { id: 'ck1', slot: 'A' }, nextLoser: { id: 'ck2', slot: 'A' } },
                    { id: 'bk2', label: 'NAM BK2', court: 'S√¢n 2', nextWinner: { id: 'ck1', slot: 'B' }, nextLoser: { id: 'ck2', slot: 'B' } },
                    { id: 'bk3', label: 'N·ªÆ BK1', court: 'S√¢n 3', nextWinner: { id: 'ck3', slot: 'A' }, nextLoser: { id: 'ck4', slot: 'A' } },
                    { id: 'bk4', label: 'N·ªÆ BK2', court: 'S√¢n 4', nextWinner: { id: 'ck3', slot: 'B' }, nextLoser: { id: 'ck4', slot: 'B' } },
                    { id: 'bk5', label: 'NAM-N·ªÆ BK1', court: 'S√¢n 5', nextWinner: { id: 'ck5', slot: 'A' }, nextLoser: { id: 'ck6', slot: 'A' } },
                    { id: 'bk6', label: 'NAM-N·ªÆ BK2', court: 'S√¢n 6', nextWinner: { id: 'ck5', slot: 'B' }, nextLoser: { id: 'ck6', slot: 'B' } },
                ]
            },
            'chung-ket': {
                1: [
                    { id: 'ck1', label: 'CHUNG K·∫æT NAM', court: 'S√¢n 1' }, { id: 'ck2', label: 'H·∫†NG 3 NAM', court: 'S√¢n 2' },
                    { id: 'ck3', label: 'CHUNG K·∫æT N·ªÆ', court: 'S√¢n 3' }, { id: 'ck4', label: 'H·∫†NG 3 N·ªÆ', court: 'S√¢n 4' },
                    { id: 'ck5', label: 'CHUNG K·∫æT N-N·ªÆ', court: 'S√¢n 5' }, { id: 'ck6', label: 'H·∫†NG 3 N-N·ªÆ', court: 'S√¢n 6' },
                ]
            }
        };

        function initDB() {
            db = { 'tu-ket': {}, 'ban-ket': {}, 'chung-ket': {} };
            [1, 2].forEach(r => {
                db['tu-ket'][r] = {};
                matchTemplates['tu-ket'][r].forEach(m => {
                    db['tu-ket'][r][m.id] = { teamA: '', teamB: '', isFixedA: false, isFixedB: false, currentSet: 1, liveScore: { a: 0, b: 0 }, sets: [], finished: false, winner: '' };
                });
            });
            ['ban-ket', 'chung-ket'].forEach(p => {
                db[p][1] = {};
                matchTemplates[p][1].forEach(m => {
                    db[p][1][m.id] = { teamA: '', teamB: '', isFixedA: false, isFixedB: false, currentSet: 1, liveScore: { a: 0, b: 0 }, sets: [], finished: false, winner: '' };
                });
            });
            saveDB();
            renderMatches();
        }

        function saveDB() { localStorage.setItem('vt_badminton_db_v12', JSON.stringify(db)); }

        function renderMatches() {
            const grid = document.getElementById('court-grid');
            const bxhCont = document.getElementById('bxh-container');
            if (currentTab === 'bxh') {
                grid.classList.add('hidden');
                bxhCont.classList.remove('hidden');
                renderBXH();
                return;
            }
            grid.classList.remove('hidden');
            bxhCont.classList.add('hidden');
            
            grid.innerHTML = '';
            const activeTemplates = matchTemplates[currentTab][currentRound];
            const activeData = db[currentTab][currentRound];

            activeTemplates.forEach(m => {
                const data = activeData[m.id];
                const card = document.createElement('div');
                card.className = `court-card bg-white rounded-[2rem] border border-slate-100 overflow-hidden flex flex-col ${data.finished ? 'opacity-90 bg-slate-50 border-vt/30' : 'shadow-sm'}`;
                
                let setsHtml = '';
                for(let i=0; i<3; i++) {
                    const set = data.sets[i];
                    const isCur = !data.finished && (data.currentSet === i + 1);
                    setsHtml += `
                        <div class="flex flex-col items-center">
                            <span class="text-[7px] font-bold text-slate-300 mb-1">H${i+1}</span>
                            <div class="w-8 h-9 rounded-lg ${set ? 'bg-vt text-white' : isCur ? 'bg-white border border-vt border-dashed' : 'bg-slate-50'} flex flex-col items-center justify-center">
                                ${set ? `<span class="text-[9px] font-black">${set.a}</span><span class="text-[9px] font-black">${set.b}</span>` : ''}
                            </div>
                        </div>`;
                }

                card.innerHTML = `
                    <div class="px-5 py-3 bg-slate-50/50 flex justify-between items-center border-b border-slate-50">
                        <div>
                            <span class="text-[8px] font-black text-vt tracking-widest uppercase">${m.court}</span>
                            <h4 class="text-[12px] font-extrabold text-slate-800">${m.label}</h4>
                        </div>
                        <div class="flex gap-1">${setsHtml}</div>
                    </div>
                    <div class="p-5 flex-1 space-y-4 relative">
                        ${data.finished ? `
                        <div class="absolute inset-0 bg-white/60 backdrop-blur-[1px] z-10 flex flex-col items-center justify-center animate-fade">
                            <div class="bg-vt text-white px-4 py-2 rounded-2xl shadow-xl border-2 border-white text-center scale-110">
                                <p class="text-[10px] font-black uppercase tracking-tighter opacity-80">Chi·∫øn Th·∫Øng</p>
                                <p class="text-sm font-black leading-tight">${data.winner}</p>
                            </div>
                        </div>` : ''}
                        <div class="flex items-center justify-between">
                            <div class="flex-1 truncate">
                                <label class="text-[9px] font-bold text-slate-300 uppercase block">${data.isFixedA ? 'V√≤ng tr∆∞·ªõc (Kh√≥a)' : 'ƒê·ªôi A'}</label>
                                <input type="text" value="${data.teamA}" ${data.isFixedA ? 'readonly' : ''} onchange="updateName('${m.id}', 'teamA', this.value)" class="bg-transparent font-bold text-slate-700 w-full outline-none text-sm" placeholder="...">
                            </div>
                            <div class="flex items-center gap-3">
                                <button onclick="score('${m.id}', 'a', 1)" class="w-10 h-10 bg-vt text-white rounded-xl flex items-center justify-center active:scale-90 shadow-lg shadow-vt/20">+</button>
                                <span class="text-3xl font-black ${data.liveScore.a > data.liveScore.b ? 'text-vt' : 'text-slate-300'}">${data.liveScore.a}</span>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex-1 truncate">
                                <label class="text-[9px] font-bold text-slate-300 uppercase block">${data.isFixedB ? 'V√≤ng tr∆∞·ªõc (Kh√≥a)' : 'ƒê·ªôi B'}</label>
                                <input type="text" value="${data.teamB}" ${data.isFixedB ? 'readonly' : ''} onchange="updateName('${m.id}', 'teamB', this.value)" class="bg-transparent font-bold text-slate-700 w-full outline-none text-sm" placeholder="...">
                            </div>
                            <div class="flex items-center gap-3">
                                <button onclick="score('${m.id}', 'b', 1)" class="w-10 h-10 bg-slate-800 text-white rounded-xl flex items-center justify-center active:scale-90 shadow-lg shadow-slate-800/20">+</button>
                                <span class="text-3xl font-black ${data.liveScore.b > data.liveScore.a ? 'text-slate-800' : 'text-slate-300'}">${data.liveScore.b}</span>
                            </div>
                        </div>
                    </div>
                    <div class="p-5 pt-0">
                        ${data.finished ? 
                            `<button onclick="reopen('${m.id}')" class="w-full py-3 bg-slate-100 text-slate-400 rounded-xl text-[10px] font-black uppercase">S·ª≠a k·∫øt qu·∫£</button>` :
                            `<button onclick="openModal('${m.id}')" class="w-full py-4 bg-vt/5 text-vt border border-vt/20 rounded-xl text-[10px] font-black uppercase tracking-widest">Hi·ªáp ${data.currentSet}</button>`
                        }
                    </div>`;
                grid.appendChild(card);
            });
        }

        function renderBXH() {
            const content = document.getElementById('bxh-content');
            content.innerHTML = '';
            
            const categories = [
                { name: 'N·ªôi dung Nam', ids: { final: 'ck1', third: 'ck2' } },
                { name: 'N·ªôi dung N·ªØ', ids: { final: 'ck3', third: 'ck4' } },
                { name: 'ƒê√¥i Nam - N·ªØ', ids: { final: 'ck5', third: 'ck6' } }
            ];

            categories.forEach(cat => {
                const fData = db['chung-ket'][1][cat.ids.final];
                const tData = db['chung-ket'][1][cat.ids.third];
                
                let rank1 = '...', rank2 = '...', rank3 = '...';
                
                if (fData.finished) {
                    rank1 = fData.winner;
                    rank2 = fData.winner === fData.teamA ? fData.teamB : fData.teamA;
                }
                if (tData.finished) {
                    rank3 = tData.winner;
                }

                const widget = document.createElement('div');
                widget.className = 'bg-white rounded-[2.5rem] p-8 shadow-sm border border-slate-100 flex flex-col items-center';
                widget.innerHTML = `
                    <h3 class="text-sm font-black text-slate-400 uppercase tracking-widest mb-8">${cat.name}</h3>
                    <div class="w-full space-y-6">
                        <div class="flex items-center gap-4 bg-slate-50 p-4 rounded-3xl relative overflow-hidden">
                            <div class="w-12 h-12 podium-1 rounded-2xl flex items-center justify-center text-white font-black text-xl shadow-lg">1</div>
                            <div>
                                <p class="text-[9px] font-bold text-slate-400 uppercase">V√¥ ƒê·ªãch</p>
                                <p class="text-sm font-black text-slate-800">${rank1}</p>
                            </div>
                            <div class="absolute right-0 top-0 bottom-0 w-1 bg-yellow-400"></div>
                        </div>
                        <div class="flex items-center gap-4 bg-slate-50 p-4 rounded-3xl">
                            <div class="w-12 h-12 podium-2 rounded-2xl flex items-center justify-center text-white font-black text-xl shadow-lg">2</div>
                            <div>
                                <p class="text-[9px] font-bold text-slate-400 uppercase">H·∫°ng Nh√¨</p>
                                <p class="text-sm font-black text-slate-800">${rank2}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-4 bg-slate-50 p-4 rounded-3xl">
                            <div class="w-12 h-12 podium-3 rounded-2xl flex items-center justify-center text-white font-black text-xl shadow-lg">3</div>
                            <div>
                                <p class="text-[9px] font-bold text-slate-400 uppercase">H·∫°ng Ba</p>
                                <p class="text-sm font-black text-slate-800">${rank3}</p>
                            </div>
                        </div>
                    </div>
                `;
                content.appendChild(widget);
            });
        }

        function autoPromote(matchId) {
            const template = matchTemplates[currentTab][currentRound].find(t => t.id === matchId);
            const data = db[currentTab][currentRound][matchId];
            if (!data.finished || !data.winner) return;

            if (currentTab === 'tu-ket' && template.next) {
                const target = db['ban-ket'][1][template.next.id];
                if (template.next.slot === 'A') { target.teamA = data.winner; target.isFixedA = true; }
                else { target.teamB = data.winner; target.isFixedB = true; }
            } else if (currentTab === 'ban-ket' && template.nextWinner) {
                const winner = data.winner, loser = (winner === data.teamA) ? data.teamB : data.teamA;
                const wTarget = db['chung-ket'][1][template.nextWinner.id];
                if (template.nextWinner.slot === 'A') { wTarget.teamA = winner; wTarget.isFixedA = true; }
                else { wTarget.teamB = winner; wTarget.isFixedB = true; }
                const lTarget = db['chung-ket'][1][template.nextLoser.id];
                if (template.nextLoser.slot === 'A') { lTarget.teamA = loser; lTarget.isFixedA = true; }
                else { lTarget.teamB = loser; lTarget.isFixedB = true; }
            }
            saveDB();
        }

        function switchTab(tabId) {
            currentTab = tabId; currentRound = 1;
            document.querySelectorAll('header button[id^="tab-"]').forEach(btn => {
                btn.classList.toggle('tab-active', btn.id === `tab-${tabId}`);
                btn.classList.toggle('text-white/70', btn.id !== `tab-${tabId}`);
            });
            document.getElementById('round-selector').style.display = (tabId === 'tu-ket') ? 'flex' : 'none';
            const titles = { 'tu-ket': 'V√≤ng T·ª© K·∫øt', 'ban-ket': 'V√≤ng B√°n K·∫øt', 'chung-ket': 'V√≤ng Chung K·∫øt', 'bxh': 'B·∫£ng X·∫øp H·∫°ng' };
            document.getElementById('phase-title').innerText = titles[tabId];
            updateRoundUI(); renderMatches();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function switchRound(r) { currentRound = r; updateRoundUI(); renderMatches(); }

        function updateRoundUI() {
            const r1 = document.getElementById('btn-round-1'), r2 = document.getElementById('btn-round-2');
            if(!r1 || !r2) return;
            [r1, r2].forEach((r, idx) => {
                const isActive = (idx + 1) === currentRound;
                r.className = `px-6 py-2 rounded-full text-xs font-bold border border-vt transition-all ${isActive ? 'bg-vt text-white' : 'text-vt bg-white'}`;
            });
        }

        function updateName(id, field, val) { 
            const d = db[currentTab][currentRound][id];
            if ((field === 'teamA' && d.isFixedA) || (field === 'teamB' && d.isFixedB)) return;
            d[field] = val; saveDB(); 
        }
        
        function score(id, team, delta) {
            const d = db[currentTab][currentRound][id];
            if(d.finished) return;
            d.liveScore[team] = Math.max(0, d.liveScore[team] + delta);
            saveDB(); renderMatches();
        }

        function openModal(id) {
            const d = db[currentTab][currentRound][id];
            if(!d.teamA.trim() || !d.teamB.trim()) { showToast("Nh·∫≠p t√™n ƒë·ªôi!"); return; }
            document.getElementById('modal-team-a').innerText = d.teamA;
            document.getElementById('modal-team-b').innerText = d.teamB;
            document.getElementById('modal-score-a').innerText = d.liveScore.a;
            document.getElementById('modal-score-b').innerText = d.liveScore.b;
            document.getElementById('confirm-finish-btn').onclick = () => confirmFinish(id);
            document.getElementById('history-modal').classList.replace('hidden', 'flex');
        }

        function closeModal() { document.getElementById('history-modal').classList.replace('flex', 'hidden'); }

        function confirmFinish(id) {
            const d = db[currentTab][currentRound][id];
            d.sets.push({ a: d.liveScore.a, b: d.liveScore.b });
            const wA = d.sets.filter(s => s.a > s.b).length, wB = d.sets.filter(s => s.b > s.a).length;
            if(wA === 2 || wB === 2 || d.sets.length === 3) {
                if (wA === wB) { d.sets.pop(); showToast("ƒê√°nh ti·∫øp hi·ªáp quy·∫øt ƒë·ªãnh!"); }
                else { d.finished = true; d.winner = wA > wB ? d.teamA : d.teamB; autoPromote(id); showToast(`X√°c nh·∫≠n: ${d.winner} th·∫Øng!`); }
            } else { d.currentSet++; }
            d.liveScore = { a: 0, b: 0 };
            saveDB(); closeModal(); renderMatches();
        }

        function reopen(id) {
            if(confirm("M·ªü l·∫°i tr·∫≠n ƒë·∫•u n√†y?")) {
                const d = db[currentTab][currentRound][id];
                const last = d.sets.pop();
                d.liveScore = { a: last.a, b: last.b };
                d.finished = false; d.winner = ''; d.currentSet = d.sets.length + 1;
                saveDB(); renderMatches();
            }
        }

        function resetTournament() { if(confirm("X√≥a to√†n b·ªô d·ªØ li·ªáu?")) initDB(); }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.classList.replace('opacity-0', 'opacity-100'); t.classList.replace('translate-y-10', 'translate-y-0');
            setTimeout(() => { t.classList.replace('opacity-100', 'opacity-0'); t.classList.replace('translate-y-0', 'translate-y-10'); }, 3000);
        }

        if (!db) initDB();
        else renderMatches();
    </script>
</body>
</html>